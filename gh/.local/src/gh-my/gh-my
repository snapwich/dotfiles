#!/usr/bin/env bash

cmd_checks() {
  check_data=$(gh pr checks --json bucket,state,workflow,name,link)
  pass=$(echo "$check_data" | jq '[.[] | select((.bucket == "pass") and (.state != "SKIPPED"))] | length')
  fail=$(echo "$check_data" | jq '[.[] | select(.bucket == "fail")] | length')
  total=$(echo "$check_data" | jq '[.[] | select(.state != "SKIPPED")] | length')

  echo "$pass / $total checks passing"

  if [ "$fail" -gt 0 ]; then
    echo ""
    echo "$fail failed checks:"
    echo "$check_data" | jq -r '.[] | select(.bucket == "fail") | "  - \(.state): \(if .workflow != "" then "\(.workflow) / " else "" end)\(.name)\n    \(.link)"'
  fi
}

cmd_reviews() {
  gh pr view --json reviews | jq -r '.reviews[] | "\(.author.login): \(.state)"'
}

cmd_comments() {
  # Get PR number from arg or current PR
  pr_num="${2:-$(gh pr view --json number -q .number 2>/dev/null)}"

  if [ -z "$pr_num" ]; then
    echo "Error: No PR number provided and no current PR found"
    exit 1
  fi

  # Get repo org/name
  repo=$(gh repo view --json nameWithOwner -q .nameWithOwner)

  # Fetch comments
  comments=$(GH_PAGER= gh api "/repos/$repo/pulls/$pr_num/comments")

  # Process each comment
  echo "$comments" | jq -r '.[] |
    "---\n" +
    (if .diff_hunk then
      "\n<<<DIFF\ndiff --git a/\(.path) b/\(.path)\n--- a/\(.path)\n+++ b/\(.path)\n\(.diff_hunk)\nDIFF>>>\n"
    else "" end) +
    (if .start_line then "\nLines \(.start_line)-\(.line)\n" elif .line then "\nLine \(.line)\n" else "" end) +
    "\n## \(.user.login) - \(.created_at)\n\n\(.body)\n"
  ' | {
    in_diff=false
    diff_content=""

    while IFS= read -r line; do
      if [[ "$line" == "<<<DIFF" ]]; then
        in_diff=true
        diff_content=""
      elif [[ "$line" == "DIFF>>>" ]]; then
        in_diff=false
        echo "$diff_content" | delta --paging=never
      elif $in_diff; then
        diff_content+="$line"$'\n'
      else
        if [[ "$line" == "---" ]]; then
          echo ""
        fi
        echo "$line"
      fi
    done
  }
}

cmd_merge() {
  gh pr merge --squash -t "$(gh pr view --json title | jq -r .title) (#$(gh pr view --json number | jq -r .number))" -b ""
}

case "${1:-}" in
checks)
  cmd_checks
  ;;
reviews)
  cmd_reviews
  ;;
comments)
  cmd_comments "$@"
  ;;
merge)
  cmd_merge
  ;;
*)
  echo "Usage: gh my <command> [args]"
  echo ""
  echo "Commands:"
  echo "  checks - Show PR check status"
  echo "  reviews - Show PR review status"
  echo "  comments [pr-number] - Show PR review comments"
  echo "  merge - Squash merge PR using PR title"
  exit 1
  ;;
esac
